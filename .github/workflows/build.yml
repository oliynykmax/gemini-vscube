name: Build and Release

on:
  push:
    branches: [main]
    tags: ["v*"]
  pull_request:
    branches: [main]

permissions:
  contents: write

jobs:
  build-macos:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install

      - name: Build
        run: bun run build:release

      - name: Create macOS Archive
        run: |
          set -e
          cd build
          BUILD_DIR=$(find . -type d -name "*macos*" | head -1)
          if [ -z "$BUILD_DIR" ]; then BUILD_DIR="."; fi
          cd "$BUILD_DIR"
          APP_DIR=$(find . -name "*.app" -type d | head -1)
          if [ -z "$APP_DIR" ]; then
            mkdir -p VSCubing-Desktop
            cp -r */* VSCubing-Desktop/ 2>/dev/null || cp -r * VSCubing-Desktop/
            printf '%s\n' 'VSCubing Desktop - macOS' '========================' '' 'To run:' '1. Navigate to the VSCubing-Desktop folder' '2. Run: ./bin/launcher' '' 'Requirements: macOS 11 or later' 'Note: This is an unsigned build. Right-click and select "Open" the first time.' '' 'For support: https://github.com/oliynykmax/gemini-vscube' > VSCubing-Desktop/README.txt
            zip -r ../../VSCubing-Desktop-macOS.zip VSCubing-Desktop/
          else
            mkdir -p "VSCubing Desktop"
            cp -r "$APP_DIR" "VSCubing Desktop/"
            printf '%s\n' 'VSCubing Desktop - macOS' '========================' '' 'To run:' '1. Open "VSCubing Desktop" folder' '2. Double-click the .app bundle' '' 'Requirements: macOS 11 or later' 'Note: This is an unsigned build. Right-click and select "Open" the first time.' '' 'For support: https://github.com/oliynykmax/gemini-vscube' > "VSCubing Desktop/README.txt"
            zip -r ../../VSCubing-Desktop-macOS.zip "VSCubing Desktop/"
          fi

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: VSCubing-macOS
          path: VSCubing-Desktop-macOS.zip
          if-no-files-found: error

  build-linux:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install

      - name: Build
        run: bun run build:release

      - name: Create Linux Archive
        run: |
          set -e
          cd build
          BUILD_DIR=$(find . -type d -name "*linux*" | head -1)
          if [ -z "$BUILD_DIR" ]; then BUILD_DIR="."; fi
          cd "$BUILD_DIR"
          APP_DIR=$(find . -maxdepth 1 -type d | grep -v "^\\.$" | head -1)
          if [ -z "$APP_DIR" ]; then APP_DIR="."; fi
          mkdir -p VSCubing-Desktop
          cp -r "$APP_DIR"/* VSCubing-Desktop/
          printf '#!/bin/bash\nDIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"\ncd "$DIR"\n./bin/launcher\n' > VSCubing-Desktop/run.sh
          chmod +x VSCubing-Desktop/run.sh
          chmod +x VSCubing-Desktop/bin/launcher 2>/dev/null || true
          chmod +x VSCubing-Desktop/bin/bun 2>/dev/null || true
          printf '%s\n' 'VSCubing Desktop - Linux' '========================' '' 'To run:' '1. Open a terminal' '2. Navigate to this directory' '3. Run: ./run.sh' '' 'Or run directly: ./bin/launcher' '' 'Requirements: Linux with GTK support' '' 'For support: https://github.com/oliynykmax/gemini-vscube' > VSCubing-Desktop/README.txt
          zip -r ../../VSCubing-Desktop-Linux.zip VSCubing-Desktop/

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: VSCubing-Linux
          path: VSCubing-Desktop-Linux.zip
          if-no-files-found: error

  build-windows:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install

      - name: Build
        run: bun run build:release

      - name: Create Windows Archive
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"
          cd build
          $buildDir = Get-ChildItem -Directory | Where-Object { $_.Name -like "*win*" } | Select-Object -First 1
          if (-not $buildDir) { $buildDir = Get-Item "." }
          cd $buildDir
          $appDir = Get-ChildItem -Directory | Select-Object -First 1
          if (-not $appDir) { $appDir = Get-Item "." }
          New-Item -ItemType Directory -Force -Path "VSCubing-Desktop"
          Copy-Item -Path "$($appDir.FullName)\*" -Destination "VSCubing-Desktop\" -Recurse -Force
          $batContent = "@echo off`r`necho VSCubing Desktop`r`necho ================`r`necho.`r`ncd /d `"%~dp0`"`r`nstart bin\launcher.exe"
          Set-Content -Path "VSCubing-Desktop\Run.bat" -Value $batContent -Encoding ASCII
          $readmeContent = "VSCubing Desktop - Windows`r`n==========================`r`n`r`nTo run:`r`n1. Double-click on Run.bat`r`n2. Or navigate to bin folder and run launcher.exe`r`n`r`nRequirements: Windows 10 or later`r`n`r`nFor support: https://github.com/oliynykmax/gemini-vscube"
          Set-Content -Path "VSCubing-Desktop\README.txt" -Value $readmeContent -Encoding ASCII
          Compress-Archive -Path "VSCubing-Desktop" -DestinationPath "..\..\VSCubing-Desktop-Windows.zip" -Force

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: VSCubing-Windows
          path: VSCubing-Desktop-Windows.zip
          if-no-files-found: error

  release:
    needs: [build-macos, build-linux, build-windows]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    steps:
      - uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4

      - name: Display structure
        run: ls -R

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            VSCubing-macOS/VSCubing-Desktop-macOS.zip
            VSCubing-Linux/VSCubing-Desktop-Linux.zip
            VSCubing-Windows/VSCubing-Desktop-Windows.zip
          draft: false
          prerelease: false
          generate_release_notes: true
          body: |
            ## VSCubing Desktop
            
            A dual-mode desktop application for VSCubing - practice offline or connect to vscubing.com
            
            ### Downloads
            
            Choose your platform:
            - **macOS**: Download `VSCubing-Desktop-macOS.zip`
            - **Linux**: Download `VSCubing-Desktop-Linux.zip`  
            - **Windows**: Download `VSCubing-Desktop-Windows.zip`
            
            ### Installation
            
            1. Download the appropriate zip file for your platform
            2. Extract the zip file
            3. Follow the README.txt in the extracted folder
            
            ### Features
            
            - **Global Mode**: Connect to https://vscubing.com with persistent sessions
            - **Local Mode**: Offline practice with local SQLite database
            - Cross-platform support (macOS, Linux, Windows)
            
            For more information, visit: https://github.com/oliynykmax/gemini-vscube
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
